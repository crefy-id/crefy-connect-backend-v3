name: Deploy to Contabo

on:
    push:
        branches:
            - main
            - develop
    workflow_dispatch:
        inputs:
            environment:
                description: 'Deployment environment'
                required: true
                default: 'staging'
                type: choice
                options:
                    - staging
                    - production

env:
    NODE_VERSION: '20'
    PNPM_VERSION: '8'
    DEPLOY_PATH: '/var/www/www.crefy.xyz/crefy-connect-backend-v3'

jobs:
    pre-deployment:
        name: Pre-deployment Checks
        runs-on: ubuntu-latest
        outputs:
            environment: ${{ steps.environment.outputs.environment }}
            deploy_version: ${{ steps.version.outputs.version }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Determine deployment environment
              id: environment
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
                  elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    echo "environment=production" >> $GITHUB_OUTPUT
                  else
                    echo "environment=staging" >> $GITHUB_OUTPUT
                  fi

            - name: Get deployment version
              id: version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                  echo "version=$VERSION-$TIMESTAMP" >> $GITHUB_OUTPUT
                  echo "Deployment version: $VERSION-$TIMESTAMP"

    build:
        name: Build Application
        runs-on: ubuntu-latest
        needs: pre-deployment

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup PNPM
              uses: pnpm/action-setup@v2
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run tests
              run: pnpm test

            - name: Build application
              run: pnpm build

            - name: Create deployment package
              run: |
                  mkdir -p deployment
                  cp -r dist package.json pnpm-lock.yaml .env.example deployment/
                  tar -czf deployment.tar.gz deployment/

            - name: Upload deployment artifact
              uses: actions/upload-artifact@v4
              with:
                  name: deployment-package
                  path: deployment.tar.gz

    deploy-to-contabo:
        name: Deploy to Contabo
        runs-on: ubuntu-latest
        needs: [pre-deployment, build]

        steps:
            - name: Download deployment artifact
              uses: actions/download-artifact@v4
              with:
                  name: deployment-package

            - name: Setup SSH
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.CONTABO_SSH_KEY }}

            - name: Copy files to Contabo
              run: |
                  scp -o StrictHostKeyChecking=no deployment.tar.gz ${{ secrets.CONTABO_USERNAME }}@${{ secrets.CONTABO_HOST }}:${{ env.DEPLOY_PATH }}/deployment.tar.gz

            - name: Deploy on Contabo server
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.CONTABO_HOST }}
                  username: ${{ secrets.CONTABO_USERNAME }}
                  password: ${{ secrets.CONTABO_PASSWORD }}
                  script: |
                      cd ${{ env.DEPLOY_PATH }}

                      # Stop the current application
                      echo "Stopping current application..."
                      pm2 stop crefy-backend || true

                      # Backup current deployment
                      echo "Backing up current deployment..."
                      tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz dist package.json pnpm-lock.yaml node_modules

                      # Extract new deployment
                      echo "Extracting new deployment..."
                      tar -xzf deployment.tar.gz
                      cp -r deployment/* .
                      rm -rf deployment deployment.tar.gz

                      # Install dependencies
                      echo "Installing dependencies..."
                      npm install -g pnpm
                      pnpm install --frozen-lockfile --prod

                      # Copy environment file if it exists
                      if [ -f .env ]; then
                        cp .env .env.backup
                      fi
                      if [ -f .env.example ]; then
                        cp .env.example .env
                      fi
                      if [ -f .env.backup ]; then
                        cp .env.backup .env
                      fi

                      # Start application with PM2
                      echo "Starting application..."
                      pm2 start dist/server.js --name "crefy-backend" --update-env
                      pm2 save

                      # Run database migrations if needed
                      # npx prisma migrate deploy

                      echo "Deployment completed successfully!"

            - name: Health check
              run: |
                  sleep 10
                  curl -f http://${{ secrets.CONTABO_HOST }}:3000/health || exit 1

            - name: Verify deployment
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.CONTABO_HOST }}
                  username: ${{ secrets.CONTABO_USERNAME }}
                  password: ${{ secrets.CONTABO_PASSWORD }}
                  script: |
                      echo "Deployment verification:"
                      echo "PM2 Status:"
                      pm2 status
                      echo "Application logs:"
                      pm2 logs crefy-backend --lines 10

    notify:
        name: Notify Deployment Status
        runs-on: ubuntu-latest
        needs: [pre-deployment, deploy-to-contabo]
        if: always()

        steps:
            - name: Notify on success
              if: needs.deploy-to-contabo.result == 'success'
              run: |
                  echo "üöÄ Deployment to ${{ needs.pre-deployment.outputs.environment }} completed successfully!"
                  echo "Version: ${{ needs.pre-deployment.outputs.deploy_version }}"
                  echo "Server: ${{ secrets.CONTABO_HOST }}"

            - name: Notify on failure
              if: needs.deploy-to-contabo.result == 'failure'
              run: |
                  echo "‚ùå Deployment to ${{ needs.pre-deployment.outputs.environment }} failed!"
                  exit 1
